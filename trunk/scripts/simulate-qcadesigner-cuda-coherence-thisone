now=$(date +%s)
echo These files will be used for testing:
echo $1
if [ ! -f ../data/circuits/$1 ]
then
	echo "Usage: $0 file.qca {email_1 ... email_n}"
	echo "file.qca must exist in ../data/circuits"
else	
	echo Simulating $1...
	touch ../data/sim_outputs/coherence/$1-$now-cuda.log
	../bin/qcadesigner-cuda -f ../data/circuits/$1 -o ../scripts/coherence_options_$1.txt -n 1 -t 0.001 -e COHERENCE_VECTOR -s ../data/sim_outputs/coherence/$1-$now | tee ../data/sim_outputs/coherence/$1-$now-cuda.log
	echo Done simulating $1.
	cd ../data
	rm gnuplot/circuit
	cp -T sim_outputs/coherence/$1-$now-cuda.out gnuplot/circuit
	cd gnuplot
	gnuplot script_plot.gpi
	mv -T circuit.png ../sim_outputs/coherence/$1-$now-cuda.png
	rm circuit
	
	for mail in $@
	do
		if [ ! -f ../data/circuits/$mail ]
		then
			echo Emailing data to: $mail
			echo Subject: $1-$now-cuda - Simulation done.
			echo Body: $(cat ../sim_outputs/coherence/$1-$now-cuda.log)
			echo Attachment: $1-$now-cuda.png
			cat ../sim_outputs/coherence/$1-$now-cuda.log | mutt -s "$1-$now-cuda - Simulation done." -a $1-$now-cuda.png -- $mail
			#mail -s "$1-$now-cuda - Simulation done." $mail < sim_outputs/coherence/$1-$now-cuda.log
		fi
	done
	cd ../../scripts
fi
echo All done.
